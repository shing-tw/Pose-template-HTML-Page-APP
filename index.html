<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>體態拍攝模板（三姿勢）</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      transition: background 0.2s, color 0.2s;
    }
    body.bright {
      background: #ffffff;
      color: #000;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 12px 8px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .camera-frame {
      position: relative;
      width: 100%;
      aspect-ratio: 3 / 4; /* 固定 3:4 */
      margin: 0 auto;
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid #00c3ff;
      background: #000;
    }
    body.bright .camera-frame {
      border-color: #0070c9;
    }

    video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* 鏡像，像照鏡子 */
    }

    canvas { display: none; }

    .overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    /* 九宮格 */
    .grid-line {
      position: absolute;
      background: rgba(255, 255, 255, 0.28);
    }
    .v1 { left: 33.333%; top: 0; width: 1px; height: 100%; }
    .v2 { left: 66.666%; top: 0; width: 1px; height: 100%; }
    .h1 { top: 33.333%; left: 0; height: 1px; width: 100%; }
    .h2 { top: 66.666%; left: 0; height: 1px; width: 100%; }

    /* 對齊線：中線 + 胸線 + 腰線 */
    .center-line {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 2px;
      margin-left: -1px;
      background: rgba(0, 255, 180, 0.75);
    }
    .chest-line {
      position: absolute;
      left: 0;
      width: 100%;
      height: 2px;
      top: 38%;
      background: rgba(255, 180, 0, 0.8);
    }
    .waist-line {
      position: absolute;
      left: 0;
      width: 100%;
      height: 2px;
      top: 63%;
      background: rgba(255, 80, 200, 0.8);
    }

    /* 姿勢矩形框（取代醜人形） */
    .pose-frame {
      position: absolute;
      inset: 0;
      display: none;
    }
    .pose-frame.active { display: block; }

    /* 頭部框：上方中間 */
    .head-box {
      position: absolute;
      width: 40%;
      height: 14%;
      border-radius: 12px;
      border: 2px dashed rgba(0, 200, 255, 0.9);
      left: 50%;
      top: 8%;
      transform: translateX(-50%);
    }
    /* 軀幹框：胸到腰 */
    .torso-box {
      position: absolute;
      width: 55%;
      height: 32%;
      border-radius: 16px;
      border: 2px dashed rgba(0, 200, 255, 0.85);
      left: 50%;
      top: 26%;
      transform: translateX(-50%);
    }
    /* 骨盆～大腿上緣框 */
    .hip-box {
      position: absolute;
      width: 50%;
      height: 18%;
      border-radius: 16px;
      border: 2px dashed rgba(0, 200, 255, 0.8);
      left: 50%;
      top: 50%;
      transform: translateX(-50%);
    }
    /* 腳位置線 */
    .feet-line {
      position: absolute;
      width: 40%;
      height: 2px;
      background: rgba(0, 200, 255, 0.8);
      bottom: 9%;
      left: 50%;
      transform: translateX(-50%);
    }

    /* 側身時：整組框左右平移即可，不畫手腳 */
    .pose-left .head-box,
    .pose-left .torso-box,
    .pose-left .hip-box,
    .pose-left .feet-line {
      left: 40%;
      transform: translateX(-50%);
    }
    .pose-right .head-box,
    .pose-right .torso-box,
    .pose-right .hip-box,
    .pose-right .feet-line {
      left: 60%;
      transform: translateX(-50%);
    }

    .hint {
      position: absolute;
      left: 8px;
      top: 6px;
      font-size: 11px;
      color: #eee;
      text-shadow: 0 0 4px #000;
      line-height: 1.3;
      max-width: 76%;
    }
    body.bright .hint { color: #111; text-shadow: 0 0 4px #fff; }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .step-label {
      font-size: 14px;
      font-weight: 600;
      text-align: center;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }

    button {
      flex: 1;
      padding: 8px 6px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #00b3ff, #0077ff);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .light-btn {
      flex: none;
      font-size: 13px;
      padding: 6px 10px;
      margin: 0 auto;
      max-width: 220px;
      background: linear-gradient(135deg, #ffd54f, #ff9800);
    }

    .note {
      font-size: 11px;
      color: #ccc;
      text-align: center;
      line-height: 1.4;
      margin-top: 2px;
    }
    body.bright .note { color: #444; }
  </style>
</head>
<body>
  <div class="app">
    <div class="camera-frame">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>

      <div class="overlay">
        <!-- 九宮格 -->
        <div class="grid-line v1"></div>
        <div class="grid-line v2"></div>
        <div class="grid-line h1"></div>
        <div class="grid-line h2"></div>

        <!-- 對齊線 -->
        <div class="center-line"></div>
        <div class="chest-line"></div>
        <div class="waist-line"></div>

        <!-- 正面框 -->
        <div class="pose-frame pose-front active" data-step="0">
          <div class="head-box"></div>
          <div class="torso-box"></div>
          <div class="hip-box"></div>
          <div class="feet-line"></div>
          <div class="hint">
            步驟 1：正面<br>
            ・頭大致落在上方框內<br>
            ・胸口靠近橘色線，肚臍在粉色線附近<br>
            ・腳掌踩在底部藍色線附近，雙腳與肩同寬
          </div>
        </div>

        <!-- 左側框 -->
        <div class="pose-frame pose-left" data-step="1">
          <div class="head-box"></div>
          <div class="torso-box"></div>
          <div class="hip-box"></div>
          <div class="feet-line"></div>
          <div class="hint">
            步驟 2：左側<br>
            ・左肩面向鏡頭，耳朵靠近中線<br>
            ・自然站好，不刻意收小腹<br>
            ・腳一樣踩在藍線附近
          </div>
        </div>

        <!-- 右側框 -->
        <div class="pose-frame pose-right" data-step="2">
          <div class="head-box"></div>
          <div class="torso-box"></div>
          <div class="hip-box"></div>
          <div class="feet-line"></div>
          <div class="hint">
            步驟 3：右側<br>
            ・右肩面向鏡頭，耳朵靠近中線<br>
            ・同樣自然放鬆站立<br>
            ・完成後就有固定三角度紀錄
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="step-label" id="stepLabel">步驟 1 / 3：正面</div>
      <div class="btn-row">
        <button id="prevBtn" disabled>上一個</button>
        <button id="captureBtn">拍照並下載</button>
        <button id="nextBtn">下一個</button>
      </div>
      <button id="lightBtn" class="light-btn">補光模式：關</button>
      <div class="note">
        建議：每次都用同一支手機、同一距離與地點拍照，才能清楚看出胸肌與腰線變化。
      </div>
    </div>
  </div>

  <script>
    let currentStep = 0;
    const maxStep = 2;

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const stepLabel = document.getElementById("stepLabel");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const captureBtn = document.getElementById("captureBtn");
    const lightBtn = document.getElementById("lightBtn");
    const outlines = document.querySelectorAll(".pose-frame");

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });
        video.srcObject = stream;
      } catch (err) {
        alert("無法開啟相機，請確認瀏覽器權限或改用手機瀏覽器開啟此頁面。");
        console.error(err);
      }
    }

    function updateStepUI() {
      outlines.forEach(el => {
        const step = Number(el.dataset.step);
        el.classList.toggle("active", step === currentStep);
      });

      const labels = ["正面", "左側", "右側"];
      stepLabel.textContent = `步驟 ${currentStep + 1} / 3：${labels[currentStep]}`;

      prevBtn.disabled = currentStep === 0;
      nextBtn.disabled = currentStep === maxStep;
    }

    prevBtn.addEventListener("click", () => {
      if (currentStep > 0) {
        currentStep--;
        updateStepUI();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentStep < maxStep) {
        currentStep++;
        updateStepUI();
      }
    });

    captureBtn.addEventListener("click", () => {
      if (!video.videoWidth || !video.videoHeight) {
        alert("相機尚未準備好，請稍等一秒再試一次。");
        return;
      }

      const frameWidth = video.videoWidth;
      const frameHeight = video.videoHeight;
      const targetRatio = 3 / 4;
      let drawWidth, drawHeight, sx, sy;
      const currentRatio = frameWidth / frameHeight;

      if (currentRatio > targetRatio) {
        drawHeight = frameHeight;
        drawWidth = frameHeight * targetRatio;
        sx = (frameWidth - drawWidth) / 2;
        sy = 0;
      } else {
        drawWidth = frameWidth;
        drawHeight = frameWidth / targetRatio;
        sx = 0;
        sy = (frameHeight - drawHeight) / 2;
      }

      canvas.width = drawWidth;
      canvas.height = drawHeight;
      const ctx = canvas.getContext("2d");

      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, sx, sy, drawWidth, drawHeight, 0, 0, drawWidth, drawHeight);
      ctx.restore();

      const dataUrl = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      const label = ["front", "left", "right"][currentStep];

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");

      link.download = `body-${yyyy}${mm}${dd}-${label}.png`;
      link.href = dataUrl;
      link.click();
    });

    lightBtn.addEventListener("click", () => {
      const isBright = document.body.classList.toggle("bright");
      lightBtn.textContent = isBright ? "補光模式：開" : "補光模式：關";
    });

    initCamera();
    updateStepUI();
  </script>
</body>
</html>
